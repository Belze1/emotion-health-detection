<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G·ª£i √ù Video D·ª±a Tr√™n C·∫£m X√∫c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">Ph√¢n T√≠ch C·∫£m X√∫c</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Trang Ch·ªß</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history">L·ªãch S·ª≠</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="status-message" id="statusMessage">
            ƒêang ch·ªù d·ªØ li·ªáu c·∫£m x√∫c...
        </div>
        
        <div class="emotion-display" id="emotionDisplay"></div>
        
        <div class="video-container" id="videoContainer">
            <div class="loading">ƒêang ch·ªù d·ªØ li·ªáu...</div>
        </div>
        
        <button class="refresh-button" id="refreshButton">
            T·∫£i Th√™m Video
        </button>
    </div>

    <script>
        let currentEmotions = null;
        const socket = io({
            transports: ['websocket'],
            upgrade: false,
            reconnection: true,
            reconnectionAttempts: 5
        });

        // L·∫•y d·ªØ li·ªáu c·∫£m x√∫c t·ª´ localStorage n·∫øu c√≥
        const savedEmotions = localStorage.getItem('currentEmotions');
        if (savedEmotions) {
            try {
                currentEmotions = JSON.parse(savedEmotions);
                updateEmotionDisplay();
                fetchRecommendations();
            } catch (e) {
                console.error('Error parsing saved emotions:', e);
            }
        }

        socket.on('connect', function() {
            console.log('Socket connected');
        });

        socket.on('disconnect', function() {
            console.log('Socket disconnected');
        });

        socket.on('emotion_update', function(data) {
            console.log('Received emotion update:', data);
            currentEmotions = data.emotions;
            
            // L∆∞u c·∫£m x√∫c v√†o localStorage
            localStorage.setItem('currentEmotions', JSON.stringify(currentEmotions));
            
            updateEmotionDisplay();
            fetchRecommendations();
        });

        function updateEmotionDisplay() {
            const display = document.getElementById('emotionDisplay');
            display.innerHTML = '';
            
            if (!currentEmotions) {
                display.innerHTML = '<div class="emotion-item neutral">Ch∆∞a c√≥ d·ªØ li·ªáu c·∫£m x√∫c</div>';
                return;
            }
            
            const emotions = {
                'happy': 'Vui v·∫ª',
                'sad': 'Bu·ªìn',
                'angry': 'Gi·∫≠n d·ªØ',
                'surprise': 'Ng·∫°c nhi√™n',
                'neutral': 'B√¨nh th∆∞·ªùng'
            };
            
            for (const [key, value] of Object.entries(currentEmotions)) {
                const item = document.createElement('div');
                item.className = `emotion-item ${key}`;
                item.textContent = `${emotions[key]}: ${Math.round(value * 100)}%`;
                display.appendChild(item);
            }
        }

        function fetchRecommendations() {
            if (!currentEmotions) {
                document.getElementById('statusMessage').textContent = 'ƒêang ch·ªù d·ªØ li·ªáu c·∫£m x√∫c...';
                return;
            }

            document.getElementById('statusMessage').textContent = 'ƒêang t√¨m ki·∫øm video ph√π h·ª£p...';
            document.getElementById('videoContainer').innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
            
            fetch('/api/recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ emotion_data: currentEmotions })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                displayVideos(data.recommendations);
                document.getElementById('statusMessage').textContent = 
                    'Video ƒë∆∞·ª£c g·ª£i √Ω d·ª±a tr√™n c·∫£m x√∫c trong 5 ph√∫t g·∫ßn ƒë√¢y';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('statusMessage').textContent = `L·ªói: ${error.message}`;
                document.getElementById('videoContainer').innerHTML = 
                    '<div class="loading">Kh√¥ng th·ªÉ t·∫£i video. Vui l√≤ng th·ª≠ l·∫°i.</div>';
            });
        }

        function displayVideos(videos) {
            const container = document.getElementById('videoContainer');
            container.innerHTML = '';
            
            if (!videos || videos.length === 0) {
                container.innerHTML = '<div class="loading">Kh√¥ng t√¨m th·∫•y video ph√π h·ª£p</div>';
                return;
            }
            
            videos.forEach(video => {
                const card = document.createElement('div');
                card.className = 'video-card';
                
                const similarity = Math.round(video.similarity * 100);
                
                card.innerHTML = `
                    <iframe 
                        class="video-frame"
                        src="https://www.youtube.com/embed/${video.video_id}"
                        frameborder="0"
                        allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                    <div class="video-info">
                        <div class="video-title">${video.title}</div>
                        <div class="similarity-score">ƒê·ªô ph√π h·ª£p: ${similarity}%</div>
                        <div class="feedback-buttons">
                            <button class="feedback-button like-button" onclick="sendFeedback('${video.video_id}', 'like')">
                                üëç Th√≠ch
                            </button>
                            <button class="feedback-button dislike-button" onclick="sendFeedback('${video.video_id}', 'dislike')">
                                üëé Kh√¥ng th√≠ch
                            </button>
                            <button class="feedback-button skip-button" onclick="sendFeedback('${video.video_id}', 'skip')">
                                ‚è≠Ô∏è B·ªè qua
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function sendFeedback(videoId, feedbackType) {
            document.getElementById('statusMessage').textContent = 'ƒêang c·∫≠p nh·∫≠t ph·∫£n h·ªìi...';
            
            fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    video_id: videoId,
                    feedback_type: feedbackType,
                    emotion_data: currentEmotions
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                if (feedbackType !== 'skip') {
                    setTimeout(fetchRecommendations, 1000);
                }
                document.getElementById('statusMessage').textContent = 'C·∫£m ∆°n ph·∫£n h·ªìi c·ªßa b·∫°n!';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('statusMessage').textContent = 
                    'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ph·∫£n h·ªìi. Vui l√≤ng th·ª≠ l·∫°i.';
            });
        }

        document.getElementById('refreshButton').addEventListener('click', fetchRecommendations);

        // Ki·ªÉm tra v√† c·∫≠p nh·∫≠t ngay khi t·∫£i trang
        if (currentEmotions) {
            updateEmotionDisplay();
            fetchRecommendations();
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>