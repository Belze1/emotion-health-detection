<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G·ª£i √ù Video D·ª±a Tr√™n C·∫£m X√∫c</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">Ph√¢n T√≠ch C·∫£m X√∫c</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Trang Ch·ªß</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/history">L·ªãch S·ª≠</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="status-message" id="statusMessage">
            ƒêang ch·ªù d·ªØ li·ªáu c·∫£m x√∫c...
        </div>
        
        <div class="emotion-state">
            <h5>Tr·∫°ng Th√°i C·∫£m X√∫c Hi·ªán T·∫°i:</h5>
            <div class="emotion-display" id="emotionDisplay"></div>
            <div class="emotion-description mt-2" id="emotionDescription"></div>
            <canvas id="emotionPieChart" width="200" height="200"></canvas>
        </div>
        
        <div class="video-container mt-4" id="videoContainer">
            <div class="loading">ƒêang ch·ªù d·ªØ li·ªáu...</div>
        </div>
    </div>

    <script>
        let currentEmotions = null;
        let emotionChart = null;
        let currentRecommendations = [];
        let displayedVideoIndexes = new Set();

        const socket = io({
            transports: ['websocket'],
            upgrade: false,
            reconnection: true,
            reconnectionAttempts: 5
        });

        const emotions = {
            'happy': 'Vui v·∫ª',
            'sad': 'Bu·ªìn',
            'angry': 'Gi·∫≠n d·ªØ',
            'surprise': 'Ng·∫°c nhi√™n',
            'neutral': 'B√¨nh th∆∞·ªùng'
        };

        function updateEmotionDisplay() {
            const display = document.getElementById('emotionDisplay');
            display.innerHTML = '';
            
            if (!currentEmotions) {
                display.innerHTML = '<div class="emotion-item neutral">Ch∆∞a c√≥ d·ªØ li·ªáu c·∫£m x√∫c</div>';
                return;
            }
            
            // Lu√¥n hi·ªÉn th·ªã ƒë·ªß 5 c·∫£m x√∫c
            Object.entries(emotions).forEach(([key, label]) => {
                const value = currentEmotions[key] || 0;
                const item = document.createElement('div');
                item.className = `emotion-item ${key}`;
                item.textContent = `${label}: ${Math.round(value * 100)}%`;
                display.appendChild(item);
            });

            updateEmotionChart();
        }

        function updateEmotionChart() {
            const ctx = document.getElementById('emotionPieChart').getContext('2d');
            
            if (emotionChart) {
                emotionChart.destroy();
            }

            const colors = {
                'happy': 'rgba(75, 192, 192, 0.8)',
                'sad': 'rgba(54, 162, 235, 0.8)',
                'angry': 'rgba(255, 99, 132, 0.8)',
                'surprise': 'rgba(255, 206, 86, 0.8)',
                'neutral': 'rgba(153, 102, 255, 0.8)'
            };

            const data = Object.entries(emotions).map(([key]) => ({
                key: key,
                value: (currentEmotions && currentEmotions[key]) || 0
            }));

            emotionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.map(d => emotions[d.key]),
                    datasets: [{
                        data: data.map(d => d.value * 100),
                        backgroundColor: data.map(d => colors[d.key])
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }

        function fetchRecommendations() {
            if (!currentEmotions) {
                document.getElementById('statusMessage').textContent = 'ƒêang ch·ªù d·ªØ li·ªáu c·∫£m x√∫c...';
                return;
            }

            document.getElementById('statusMessage').textContent = 'ƒêang t√¨m ki·∫øm video ph√π h·ª£p...';
            document.getElementById('videoContainer').innerHTML = '<div class="loading">ƒêang t·∫£i...</div>';
            
            fetch('/api/recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    emotion_data: currentEmotions,
                    exclude_videos: Array.from(displayedVideoIndexes)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                currentRecommendations = data.recommendations;
                displayVideos();
                document.getElementById('statusMessage').textContent = 
                    'Video ƒë∆∞·ª£c g·ª£i √Ω d·ª±a tr√™n t·ªï h·ª£p c·∫£m x√∫c hi·ªán t·∫°i';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('statusMessage').textContent = `L·ªói: ${error.message}`;
                document.getElementById('videoContainer').innerHTML = 
                    '<div class="loading">Kh√¥ng th·ªÉ t·∫£i video. Vui l√≤ng th·ª≠ l·∫°i.</div>';
            });
        }

        function displayVideos() {
            const container = document.getElementById('videoContainer');
            container.innerHTML = '';
            
            if (!currentRecommendations || currentRecommendations.length === 0) {
                container.innerHTML = '<div class="loading">Kh√¥ng t√¨m th·∫•y video ph√π h·ª£p</div>';
                return;
            }
            
            currentRecommendations.slice(0, 4).forEach((video, index) => {
                displayedVideoIndexes.add(video.video_id);
                const card = createVideoCard(video, index);
                container.appendChild(card);
            });
        }

        function createVideoCard(video, index) {
            const card = document.createElement('div');
            card.className = 'video-card';
            card.id = `video-${index}`;
            
            const similarity = Math.round(video.similarity * 100);
            
            card.innerHTML = `
                <iframe 
                    class="video-frame"
                    src="https://www.youtube.com/embed/${video.video_id}"
                    frameborder="0"
                    allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
                <div class="video-info">
                    <div class="video-title">${video.title}</div>
                    <div class="similarity-score">ƒê·ªô ph√π h·ª£p: ${similarity}%</div>
                    <div class="feedback-buttons">
                        <button class="feedback-button like-button" onclick="sendFeedback('${video.video_id}', 'like', ${index})">
                            üëç Th√≠ch
                        </button>
                        <button class="feedback-button dislike-button" onclick="sendFeedback('${video.video_id}', 'dislike', ${index})">
                            üëé Kh√¥ng th√≠ch
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function replaceVideo(index, oldVideoId) {
            // L·∫•y video thay th·∫ø t·ª´ server
            fetch('/api/recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    emotion_data: currentEmotions,
                    exclude_videos: [...displayedVideoIndexes, oldVideoId]
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error || !data.recommendations || data.recommendations.length === 0) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y video thay th·∫ø ph√π h·ª£p');
                }

                const newVideo = data.recommendations[0];
                displayedVideoIndexes.delete(oldVideoId);
                displayedVideoIndexes.add(newVideo.video_id);
                
                const videoCard = document.getElementById(`video-${index}`);
                if (videoCard) {
                    const newCard = createVideoCard(newVideo, index);
                    videoCard.replaceWith(newCard);
                }
                document.getElementById('statusMessage').textContent = 'ƒê√£ c·∫≠p nh·∫≠t video g·ª£i √Ω';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('statusMessage').textContent = 
                    'Kh√¥ng th·ªÉ t·∫£i video thay th·∫ø. Vui l√≤ng th·ª≠ l·∫°i.';
            });
        }

        function sendFeedback(videoId, feedbackType, index) {
            document.getElementById('statusMessage').textContent = 'ƒêang c·∫≠p nh·∫≠t ph·∫£n h·ªìi...';
            
            fetch('/api/feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    video_id: videoId,
                    feedback_type: feedbackType,
                    emotion_data: currentEmotions
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                if (feedbackType === 'dislike') {
                    replaceVideo(index, videoId);
                } else {
                    document.getElementById('statusMessage').textContent = 'C·∫£m ∆°n ph·∫£n h·ªìi c·ªßa b·∫°n!';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('statusMessage').textContent = 
                    'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ph·∫£n h·ªìi. Vui l√≤ng th·ª≠ l·∫°i.';
            });
        }

        // Socket events
        socket.on('connect', function() {
            console.log('Socket connected');
        });

        socket.on('emotion_update', function(data) {
            console.log('Received emotion update:', data);
            currentEmotions = data.emotions;
            localStorage.setItem('currentEmotions', JSON.stringify(currentEmotions));
            updateEmotionDisplay();
            fetchRecommendations();
        });

        // Initial setup
        const savedEmotions = localStorage.getItem('currentEmotions');
        if (savedEmotions) {
            try {
                currentEmotions = JSON.parse(savedEmotions);
                updateEmotionDisplay();
                fetchRecommendations();
            } catch (e) {
                console.error('Error parsing saved emotions:', e);
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>